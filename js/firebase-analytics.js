/**
 * Firebase analytics module for TicTacToeExtreme
 * This module handles tracking page views, unique visitors, and game events
 */
const Analytics = (function() {
    let db;
    let initialized = false;
    
    // Storage key for client ID
    const CLIENT_ID_KEY = 'tictactoeExtreme_clientId';
    
    // Initialize Firebase
    async function initialize() {
        if (initialized) return true;
        
        try {
            // Import the required Firebase modules
            await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js');
            await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            
            // Initialize Firebase with config
            // Note: firebaseConfig is defined in the separate firebase-config.js file
            // that is generated by GitHub Actions from repository secrets
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            initialized = true;
            
            // Track the page view once initialized
            trackPageView();
            
            return true;
        } catch (error) {
            console.error('Failed to initialize Firebase:', error);
            return false;
        }
    }
    
    // Generate or retrieve client ID for tracking unique visitors
    function getClientId() {
        let clientId = localStorage.getItem(CLIENT_ID_KEY);
        if (!clientId) {
            clientId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem(CLIENT_ID_KEY, clientId);
        }
        return clientId;
    }
    
    // Track page view
    async function trackPageView() {
        if (!initialized) {
            await initialize();
        }
        
        if (!initialized) return; // Skip if initialization failed
        
        try {
            const clientId = getClientId();
            const today = new Date().toISOString().split('T')[0];
            
            // Record daily visit
            await db.collection('metrics').doc('daily-counts').set({
                [today]: firebase.firestore.FieldValue.increment(1)
            }, { merge: true });
            
            // Record unique visitor (only count once per day per client)
            const visitorKey = `${today}_${clientId}`;
            const visitorRef = db.collection('visits').doc(visitorKey);
            const visitorDoc = await visitorRef.get();
            
            if (!visitorDoc.exists) {
                // First visit today from this client
                await visitorRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    clientId: clientId,
                    date: today
                });
                
                // Increment unique visitor count
                await db.collection('metrics').doc('unique-daily').set({
                    [today]: firebase.firestore.FieldValue.increment(1)
                }, { merge: true });
            }
        } catch (error) {
            console.error('Error tracking page view:', error);
        }
    }
    
    // Track game events like game starts, completions, wins/losses
    async function trackGameEvent(eventType, eventData = {}) {
        if (!initialized) {
            await initialize();
        }
        
        if (!initialized) return; // Skip if initialization failed
        
        try {
            await db.collection('events').add({
                type: eventType,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                clientId: getClientId(),
                ...eventData
            });
        } catch (error) {
            console.error('Error tracking game event:', error);
        }
    }
    
    // Get statistics for the stats modal
    async function getStatistics() {
        if (!initialized) {
            await initialize();
        }
        
        if (!initialized) return null; // Return null if initialization failed
        
        try {
            // Basic visit metrics
            const dailyCountsDoc = await db.collection('metrics').doc('daily-counts').get();
            const uniqueCountsDoc = await db.collection('metrics').doc('unique-daily').get();
            
            const dailyCounts = dailyCountsDoc.exists ? dailyCountsDoc.data() : {};
            const uniqueCounts = uniqueCountsDoc.exists ? uniqueCountsDoc.data() : {};
            
            // Calculate totals
            const totalVisits = Object.values(dailyCounts).reduce((sum, count) => sum + count, 0);
            const totalUniques = Object.values(uniqueCounts).reduce((sum, count) => sum + count, 0);
            
            // Get today's counts
            const today = new Date().toISOString().split('T')[0];
            const todayVisits = dailyCounts[today] || 0;
            const todayUniques = uniqueCounts[today] || 0;
            
            // Get all completed games
            const gamesQuery = await db.collection('events')
                .where('type', '==', 'gameCompleted')
                .get();
                
            const totalGames = gamesQuery.size;
            
            // Process game statistics
            let playerWins = 0;
            let computerWins = 0;
            let ties = 0;
            let playerWinsAsX = 0;
            let playerWinsAsO = 0;
            
            // AI style performance
            let aggressiveTotal = 0;
            let aggressiveWins = 0;
            let defensiveTotal = 0;
            let defensiveWins = 0;
            let balancedTotal = 0;
            let balancedWins = 0;
            
            gamesQuery.forEach(doc => {
                const gameData = doc.data();
                
                // Count outcomes
                if (gameData.winner === 'player') {
                    playerWins++;
                    
                    // Track symbol
                    if (gameData.playerSymbol === 'X') {
                        playerWinsAsX++;
                    } else if (gameData.playerSymbol === 'O') {
                        playerWinsAsO++;
                    }
                } else if (gameData.winner === 'computer') {
                    computerWins++;
                } else {
                    ties++;
                }
                
                // Track AI style performance if available
                if (gameData.aiStyle) {
                    switch (gameData.aiStyle) {
                        case 'aggressive':
                            aggressiveTotal++;
                            if (gameData.winner === 'computer') aggressiveWins++;
                            break;
                        case 'defensive':
                            defensiveTotal++;
                            if (gameData.winner === 'computer') defensiveWins++;
                            break;
                        case 'balanced':
                            balancedTotal++;
                            if (gameData.winner === 'computer') balancedWins++;
                            break;
                    }
                }
            });
            
            // Calculate win rates
            const playerWinRate = totalGames > 0 ? (playerWins / totalGames * 100).toFixed(1) : 0;
            const computerWinRate = totalGames > 0 ? (computerWins / totalGames * 100).toFixed(1) : 0;
            const tieRate = totalGames > 0 ? (ties / totalGames * 100).toFixed(1) : 0;
            
            // Calculate AI style win rates
            const aggressiveWinRate = aggressiveTotal > 0 ? (aggressiveWins / aggressiveTotal * 100).toFixed(1) : 0;
            const defensiveWinRate = defensiveTotal > 0 ? (defensiveWins / defensiveTotal * 100).toFixed(1) : 0;
            const balancedWinRate = balancedTotal > 0 ? (balancedWins / balancedTotal * 100).toFixed(1) : 0;
            
            return {
                // Site metrics
                totalVisits,
                totalUniques,
                todayVisits,
                todayUniques,
                
                // Game metrics
                totalGames,
                playerWins,
                computerWins,
                ties,
                playerWinRate,
                computerWinRate,
                tieRate,
                
                // Symbol performance
                playerWinsAsX,
                playerWinsAsO,
                
                // AI style performance
                aggressiveTotal,
                aggressiveWins,
                aggressiveWinRate,
                defensiveTotal,
                defensiveWins,
                defensiveWinRate,
                balancedTotal,
                balancedWins,
                balancedWinRate
            };
        } catch (error) {
            console.error('Error fetching statistics:', error);
            return null;
        }
    }
    
    // Public API
    return {
        initialize,
        trackPageView,
        trackGameEvent,
        getStatistics
    };
})();